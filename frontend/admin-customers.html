<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ â€” BONITA TOUCH</title>
  <style>
    :root{
      --bg:#f8f9fa; --card:#fff; --line:#e5e7eb; --fg:#111; --muted:#6b7280;
      --accent:#6f4ef6; --success:#10b981; --danger:#ef4444;
      --radius:12px; --shadow:0 1px 3px rgba(0,0,0,.1);
    }
    *{box-sizing:border-box;margin:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--fg); min-height:100vh;
    }

    .header{
      background:#fff; border-bottom:1px solid var(--line);
      padding:16px 24px; display:flex; justify-content:space-between;
      align-items:center; box-shadow:var(--shadow); position:sticky; top:0; z-index:10;
    }
    .header-left{display:flex; align-items:center; gap:16px}
    .logo{width:48px; height:48px; border-radius:12px; object-fit:cover}
    .header-title{font-size:20px; font-weight:900}
    .header-subtitle{font-size:13px; color:var(--muted)}
    .btn-back{
      padding:8px 16px; border:1px solid var(--line); border-radius:8px;
      background:#fff; cursor:pointer; font-weight:700; transition:.2s;
      text-decoration:none; color:inherit;
    }
    .btn-back:hover{background:#f9fafb}

    .container{max-width:1400px; margin:0 auto; padding:24px}

    .stats{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px; margin-bottom:24px;
    }
    .stat-card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      padding:16px; box-shadow:var(--shadow);
    }
    .stat-value{font-size:28px; font-weight:900; margin-bottom:4px}
    .stat-label{font-size:13px; color:var(--muted)}

    .table-container{
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow);
    }
    .table-header{
      padding:16px 20px; border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center;
    }
    .table-title{font-size:18px; font-weight:900}
    .search-box{
      padding:8px 16px; border:1px solid var(--line); border-radius:8px;
      width:280px; font-size:14px;
    }

    table{width:100%; border-collapse:collapse}
    th,td{padding:16px 20px; text-align:right; border-bottom:1px solid var(--line)}
    th{background:#f9fafb; font-weight:700; font-size:13px; color:var(--muted); text-transform:uppercase}
    tr:last-child td{border-bottom:0}
    tr:hover{background:#fafbfc}

    .status-badge{
      display:inline-block; padding:4px 12px; border-radius:999px;
      font-size:12px; font-weight:700;
    }
    .status-confirmed{background:#d1fae5; color:#065f46}
    .status-cancelled{background:#fee2e2; color:#991b1b}

    .actions{display:flex; gap:8px}
    .btn{
      padding:6px 12px; border:1px solid var(--line); border-radius:6px;
      background:#fff; cursor:pointer; font-size:13px; font-weight:600; transition:.2s;
    }
    .btn-view{color:#3b82f6; border-color:#3b82f6}
    .btn-view:hover{background:#eff6ff}
    .btn-delete{color:#ef4444; border-color:#ef4444}
    .btn-delete:hover{background:#fef2f2}

    .loading,.empty{text-align:center; padding:60px; color:var(--muted)}

    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.5); display:none;
      place-items:center; z-index:999; padding:20px;
    }
    .modal.show{display:grid}
    .modal-content{
      background:#fff; border-radius:20px; width:min(700px,100%);
      max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,.3);
    }
    .modal-header{
      padding:24px; border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal-title{font-size:20px; font-weight:900}
    .modal-close{
      width:36px; height:36px; border:0; border-radius:8px;
      background:#f3f4f6; cursor:pointer; font-size:20px;
    }
    .modal-body{padding:24px}
    .detail-row{
      display:flex; justify-content:space-between; padding:12px 0;
      border-bottom:1px solid var(--line);
    }
    .detail-row:last-child{border-bottom:0}
    .detail-label{color:var(--muted); font-weight:600}
    .detail-value{font-weight:700}

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø¢Ù†) */
    .services-list{margin:12px 0}
    .service-item{
      display:flex; justify-content:space-between; align-items:center;
      padding:12px; background:#f9fafb; border-radius:8px; margin-bottom:8px;
    }
    .service-info{flex:1}
    .service-name{font-weight:700; margin-bottom:4px}
    .service-meta{font-size:13px; color:var(--muted)}

    /* Ø³ØªØ§ÙŠÙ„ Ø²Ø± Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ø§Ù‚ÙŠ Ù„ÙƒÙ† ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø§Ù„ÙŠØ§Ù‹
    .btn-delete-service{
      padding:6px 12px; border:1px solid #fca5a5; background:#fef2f2;
      color:#dc2626; border-radius:6px; cursor:pointer; font-size:12px;
      font-weight:600; transition:.2s;
    }
    .btn-delete-service:hover{background:#fee2e2}
    */

    @media (max-width:768px){
      .search-box{width:100%; margin-top:12px}
      .table-header{flex-direction:column; align-items:stretch}
      table{font-size:14px}
      th,td{padding:12px}
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <img class="logo" 
           src="https://images.fresha.com/locations/location-profile-images/873704/4817851/87cf053b-8d1c-4549-a7ef-06a12ef5b433-OMBRETOUCH-SA-Fresha.jpg" 
           alt="Logo">
      <div>
        <div class="header-title">Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="header-subtitle">BONITA TOUCH</div>
      </div>
    </div>
    <a class="btn-back" href="admin.html">â† Ø±Ø¬ÙˆØ¹</a>
  </header>

  <div class="container">
    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="totalBookings">0</div>
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="confirmedBookings">0</div>
        <div class="stat-label">Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalCustomers">0</div>
        <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
      </div>
      <div class="stat-card">
        <div class="stat-value"><span id="totalRevenue">0</span> Ø±.Ø³</div>
        <div class="stat-label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <div class="table-title">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
        <input type="search" class="search-box" placeholder="Ø¨Ø­Ø«..." id="searchBox">
      </div>
      <div class="loading" id="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <div style="overflow-x:auto; display:none" id="tableWrapper">
        <table>
          <thead>
            <tr>
              <th>Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²</th>
              <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„ÙˆÙ‚Øª</th>
              <th>Ø§Ù„Ø®Ø¯Ù…Ø§Øª</th>
              <th>Ø§Ù„Ù…Ø­ØªØ±Ù</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="empty" id="emptyState" style="display:none">
        ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª
      </div>
    </div>
  </div>

  <div class="modal" id="detailsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²</div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    let allBookings = [];
    let currentBookingId = null;

    async function loadBookings() {
      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('tableWrapper').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';

        const response = await fetch(`${API_URL}/bookings`);
        const result = await response.json();

        if (!result.success) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª');

        allBookings = result.data;

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const confirmedBookings = allBookings.filter(b => b.status === 'confirmed');
        const uniqueCustomers = new Set(allBookings.map(b => b.customer_name)).size;
        const totalRevenue = confirmedBookings.reduce((sum, b) => sum + (b.total || 0), 0);

        document.getElementById('totalBookings').textContent = allBookings.length;
        document.getElementById('confirmedBookings').textContent = confirmedBookings.length;
        document.getElementById('totalCustomers').textContent = uniqueCustomers;
        document.getElementById('totalRevenue').textContent = totalRevenue;

        renderBookings();
      } catch (error) {
        console.error('Ø®Ø·Ø£:', error);
        document.getElementById('loading').innerHTML = '<span style="color:#ef4444">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>';
      }
    }

    function renderBookings() {
      let bookings = [...allBookings];

      const search = document.getElementById('searchBox').value.toLowerCase();
      if (search) {
        bookings = bookings.filter(b => 
          b.customer_name.toLowerCase().includes(search) ||
          b.contact.value.includes(search) ||
          b.date_display.includes(search)
        );
      }

      document.getElementById('loading').style.display = 'none';

      if (bookings.length === 0) {
        document.getElementById('tableWrapper').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        return;
      }

      document.getElementById('tableWrapper').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';

      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = bookings.map(booking => `
        <tr>
          <td>#${booking.id}</td>
          <td><strong>${booking.customer_name}</strong><br><small style="color:#6b7280">${booking.contact.value}</small></td>
          <td>${booking.date_display}</td>
          <td>${booking.time}</td>
          <td>${booking.items.map(i => i.service_name).join('ØŒ ')}</td>
          <td>${booking.professional?.name || 'Ø£ÙŠ Ù…Ø­ØªØ±Ù'}</td>
          <td><strong>${booking.total} Ø±.Ø³</strong></td>
          <td><span class="status-badge status-${booking.status}">${booking.status === 'confirmed' ? 'Ù…Ø¤ÙƒØ¯' : 'Ù…Ù„ØºÙŠ'}</span></td>
          <td>
            <div class="actions">
              <button class="btn btn-view" onclick="viewDetails(${booking.id})">Ø¹Ø±Ø¶</button>
              ${booking.status === 'confirmed' ? `
                <button class="btn btn-delete" onclick="cancelBooking(${booking.id})">Ø¥Ù„ØºØ§Ø¡</button>
              ` : ''}
            </div>
          </td>
        </tr>
      `).join('');
    }

    function viewDetails(id) {
      const booking = allBookings.find(b => b.id === id);
      if (!booking) return;
      
      currentBookingId = id;

      const modal = document.getElementById('detailsModal');
      const body = document.getElementById('modalBody');

      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø²Ø± Ø­Ø°Ù)
      const servicesHTML = booking.items.map((item) => `
        <div class="service-item">
          <div class="service-info">
            <div class="service-name">${item.service_name}</div>
            <div class="service-meta">
              ${item.price} Ø±.Ø³ â€¢ ${item.minutes} Ø¯Ù‚ÙŠÙ‚Ø© â€¢ ${item.professional_name || 'Ø£ÙŠ Ù…Ø­ØªØ±Ù'}
            </div>
          </div>
        </div>
      `).join('');

      body.innerHTML = `
        <div class="detail-row">
          <span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²</span>
          <span class="detail-value">#${booking.id}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
          <span class="detail-value">${booking.customer_name}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span>
          <span class="detail-value">${booking.contact.value}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
          <span class="detail-value">${booking.date_display}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Ø§Ù„ÙˆÙ‚Øª</span>
          <span class="detail-value">${booking.time}</span>
        </div>
        <div style="padding:12px 0; border-bottom:1px solid var(--line)">
          <div class="detail-label" style="margin-bottom:12px">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</div>
          <div class="services-list">
            ${servicesHTML}
          </div>
        </div>
        <div class="detail-row">
          <span class="detail-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
          <span class="detail-value" style="color:#10b981; font-size:20px">${booking.total} Ø±.Ø³</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Ø§Ù„Ø­Ø§Ù„Ø©</span>
          <span class="detail-value">
            <span class="status-badge status-${booking.status}">
              ${booking.status === 'confirmed' ? 'Ù…Ø¤ÙƒØ¯' : 'Ù…Ù„ØºÙŠ'}
            </span>
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</span>
          <span class="detail-value">${new Date(booking.created_at).toLocaleString('ar-SA')}</span>
        </div>
      `;

      modal.classList.add('show');
    }

    // ØªÙ‚Ø¯Ø±ÙÙŠÙ† ØªØ­Ø°ÙÙŠÙ† Ø§Ù„Ø¯Ø§Ù„Ø© Ù‡Ø°ÙŠ Ù„Ùˆ Ù…Ø§ ØªØ­ØªØ§Ø¬ÙŠÙ† Ø­Ø°Ù Ø®Ø¯Ù…Ø© Ù…Ù† Ø£ÙŠ Ù…ÙƒØ§Ù†
    async function deleteService(bookingId, serviceIndex) {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø© ÙÙ‚Ø·ØŸ')) return;

      try {
        const response = await fetch(`${API_URL}/bookings/${bookingId}/items/${serviceIndex}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­');
          closeModal();
          loadBookings();
        } else {
          alert('âŒ ' + (result.error || 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©'));
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©');
      }
    }

    async function cancelBooking(id) {
      if (!confirm('Ù‡Ù„ Ø£Ù†ØªÙ Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø² Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) return;

      try {
        const response = await fetch(`${API_URL}/bookings/${id}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          alert('âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­');
          loadBookings();
        } else {
          alert('âŒ ÙØ´Ù„ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²');
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²');
      }
    }

    function closeModal() {
      document.getElementById('detailsModal').classList.remove('show');
      currentBookingId = null;
    }

    document.getElementById('searchBox').addEventListener('input', renderBookings);

    loadBookings();
  </script>
</body>
</html>
